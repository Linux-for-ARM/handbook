# Allwinner

```admonish warning title="Внимание"
В данной части предоставлены *общие* инструкции, которые приведут к сборке работающего загрузчика U-Boot, пригодного для дальнейшего использования. Конечно, «кастомная» сборка U-Boot и ряда дополнительных компонентов с другими параметрами допускается, но на данный момент я не предоставляю иных инструкций кроме этих. Возможно, что в будущем я добавлю ряд советов по изменению параметров сборки, но сейчас у меня на это нет ни времени, ни сил, ни желания.
```

## Сборка ARM Trusted Firmware (TF-A)

Для плат, использующих 64-битный SoC (A64, H5 H6, H616, R329) требуется микропрограмма [ARM Trusted Firmware-A](https://www.trustedfirmware.org/projects/tf-a/). Это эталонная реализация безопасного программного обеспечения для ARMv8-A, которая поддерживается в Allwinner SoC.

### Скачивание

Склонируйте репозиторий с микропрограммой и перейдите в склонированную директорию:

```bash
git clone https://git.trustedfirmware.org/TF-A/trusted-firmware-a.git
cd trusted-firmware-a
```

### Настройка

Теперь вам необходимо объявить переменную `PLAT_TGT`, которая будет содержать имя целевой платформы для сборки (значение этой переменной см. далее):

```bash
export PLAT_TGT="целевая платформа"
```

> **Целевые платформы для сборки:**
>
> Сборка TF-A специфична для каждого SoC, в частности, специфично значение переменной `PLAT`, которая передаётся системе сборки `make`. Вы можете воспользоваться значениями из таблицы ниже:
>
> | SoC            | Платформа     |
> |----------------|---------------|
> | Allwinner A64  | `sun50i_a64`  |
> | Allwinner H5   | `sun50i_a64`  |
> | Allwinner H6   | `sun50i_h6`   |
> | Allwinner H616 | `sun50i_h616` |
> | Allwinner H313 | `sun50i_h616` |
> | Allwinner T507 | `sun50i_h616` |
> | Allwinner R329 | `sun50i_r329` |
>
> Для поиска всех целевых платформ введите:
>
> ```bash
> find plat/allwinner -name platform.mk
> ```
> В файле [`docs/plat/allwinner.rst`](https://trustedfirmware-a.readthedocs.io/en/latest/plat/allwinner.html) содержится дополнительная информация и приведены некоторые опции сборки.

Например, если в моей плате используется SoC Allwinner H6, то значение переменной `PLAT_TGT` будет равно `sun50i_h6`:

```bash
export PLAT_TGT="sun50i_h6"
```

### Сборка

И скомпилируйте микропрограмму:

```bash
make CROSS_COMPILE=$LFA_TGT- PLAT=$PLAT_TGT DEBUG=1
```

Теперь вам нужно объявить переменную окружения `BL31`, содержащую путь до скомпилированной микропрограммы:

```bash
export BL31=$PWD/build/$PLAT_TGT/debug/bl31.bin
```

## Сборка образа U-Boot

Распакуйте архив с исходниками загрузчика и перейдите в распакованную директорию, если не сделали этого ранее.

```admonish warning title="Внимание"
Предполагается, что у вас уже установлена переменная окружения `BL31`.
```

### Настройка

> Подробные сведения о процессе настройки см. на [предыдущей](index.html#Настройка) странице. В частности, оттуда вам понадобятся сведения о том, какое значение подставлять в команду `make <имя платы>_defconfig` вместо `<имя платы>`.

```bash
make <имя платы>_defconfig
```

### Сборка

```bash
make
```

Файл, содержащий всё необходимое, называется `u-boot-sunxi-with-spl.bin` и находится в корневой папке дерева исходного кода U-Boot. За исключением необработанных NAND-устройств его можно использовать для любого источника загрузки. Devicetree платы также включено.

## Сохранение образа U-Boot

Теперь рекомендуем вам сохранить образ U-Boot в другое место, чтобы в последующих главах можно было иметь к нему доступ для выполнения дальнейших действий:

```bash
cp -v u-boot-sunxi-with-spl.bin $LFA/bootloader.bin
```

Этой командой вы скопируете образ в директорию `$LFA` под новым именем `bootloader.bin`.

---

## Установка U-Boot

```admonish bug title="Under construction!"
Инструкции ниже я перепечатал из [документации](https://docs.u-boot.org/en/latest/board/allwinner/sunxi.html#installing-u-boot) загрузчика и не уверен, что они применимы в нашем случае. Если вы знаете, как правильно устанавливать загрузчик ОС на определённый носитель информации, с которого будет происходить загрузки собранной системы LFA (MicroSD или eMMC), то, пожалуйста, свяжитесь со мной одним из следующих способов:

- [Создайте issue в репозитории руководства](https://github.com/Linux-for-ARM/handbook/issues/new), где опишете шаги по сборке и установке загрузчика;
- [Напишите мне в личку в Telegram](https://t.me/brezhnev_zhiv)
- [Напишите в Telegram-чат руководства](https://t.me/lfa_chat)

Меня интересует следующее: в `img`-образах существующих дистрибутивов (Debian, Ubuntu, Manjaro ARM, Armbian) уже существуют какие-то файлы загрузчика (если я правильно понимаю). Но я не понимаю того, как скомпилированный образ U-Boot (`u-boot-sunxi-with-spl.bin`) "засунуть" в `img`-образ системы, чтобы после его записи на SD-карту или eMMC с помощью `dd` я мог бы загрузить свою систему.

На всякий случай: меня в первую очередь интересует сборка U-Boot для Orange Pi (например, для Orange Pi 3 LTS), поскольку сейчас я располагаю именно этим компьютером.
```

### Установка на MicroSD-карту

Все SoC Allwinner пытаются найти загрузочный образ в 16 секторе (8 КБ) карты, подключенной к первому MMC-контроллеру. Чтобы перенести скомпилированный ранее образ на SD-карту с любого устройства (как с того, на котором выполнялась сборка, так и с сам*о*й платы), оснащённого устройством чтения MicroSD-карт, введите от имени пользователя `root`:

```bash
dd if=boot-sunxi-with-spl.bin of=/dev/sdX bs=1k seek=8
```

где `X` — буква (`a`, `b`, `c`) устройства, например, `/dev/sdc`. Обратите внимание на то, что в некоторых случаях вместо `sdX` имя устройства может быть `mmcblkX`.

Новые SoC (начиная с 2014 г. и включая все ARM64 SoC) также ищут подпись в секторе 256 (128 КБ). Преимущество установки туда загрузчика в том, что он не пересекается с таблицей разделов GPT. Просто замените `seek=8` на `seek=128`.
