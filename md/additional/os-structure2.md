# Заметки об ОС Linux. Часть 2. Процесс загрузки

> Б*о*льшая часть сведений здесь взята из статьи [Загрузка ОС на ARM](https://habr.com/ru/companies/aladdinrd/articles/338806/) на Хабре.

```admonish warning title="Внимание"
Здесь будут даны сведения о загрузке Linux на ARM. Особенности загрузки других ОС затронуты не будут, поскольку это не тема данного руководства.
```

## Загрузчик ОС

Загрузчик обеспечивает запуск ОС и ряд сервисных функций, например проверку целостности образа ОС перед запуском, обновление ПО, самотестирование и т.д. Очень часто в качестве загрузчика можно встретить U-Boot или иные решения с открытым исходным кодом. Для x86_64 «собратьев» обычно применяются GRUB и systemd-boot.

Таким образом, если очень сильно упростить, то процесс загрузки ОС выглядит следующим образом:

![](pic/oss2-1.png)

Здесь знаком `//` отмечен момент подачи питания или сброса процессора. Такой простой способ запуска был у некоторых процессоров ARMv7. В более новых версиях процессоров процесс куда сложнее, чем на приведённой схеме.

Схема «Загрузчик» -> «ОС» очень удобна из практических соображений, ведь загрузчик берёт на себя всю низкоуровневую работу:

- Инициализирует память перед запуском ОС и загружает ядро ОС в память
- Инициализирует часть периферии
- Иногда реализует хранение двух образов ОС: текущего и резервного или образа для восстановления

Например, для запуска Linux на ARM загрузчик должен инициализировать память, хотя бы один терминал, загрузить образ ядра и [Devicetree](dtb.md) в память и передать управление ядру. Всё это описано в [**документации**](https://www.kernel.org/doc/Documentation/arm/Booting) Linux. Код инициализации ядра Linux не будет делать сам то, что должен делать загрузчик.

Рассмотрим работу загрузчика на примере U-Boot:

1. После включения или сброса процессор загружает образ U-Boot в ОЗУ и передаёт управление на первую команду этого образа.
2. U-Boot инициализирует DDRAM.
3. U-Boot инициализирует драйверы загрузочного носителя (ЗН), например eMMC, NAND Flash и т.д.
4. U-Boot читает с ЗН область переменных конфигураций. В конфигурации задан скрипт загрузки, который U-Boot далее исполняет.
5. U-Boot выводит предложение прервать процесс загрузки и сконфигурировать устройство. Если за 2-3 секунды пользователь этого не сделает, запустится загрузочный скрипт.
6. Иногда скрипт начинается с поиска подходящего образа ОС для загрузки на всех доступных носителях. В других случаях ЗН задаётся в скрипте жёстко.
7. Скрипт загружает с ЗН в DDRAM образ ядра (`zImage`) и файл Devicetree с параметрами ядра.
8. Дополнительно скрипт может загрузить в память образ `initrd`.
9. `zImage` состоит из распаковщика и сжатого образа ядра. Распаковщик развёртывает ядро в памяти.
10. Начинается загрузка ОС.

## Предзагрузчик


