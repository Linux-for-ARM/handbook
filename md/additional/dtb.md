# Device Tree

ARM-компьютеры, в отличие от «классических» x86_64, используют специальный компонент под названием SoC (System on Chip), включающий в себя процессор и много других устройств, которые находятся на одной, как правило небольшой, микросхеме. К таким компьютерам можно отнести, к примеру, Raspberry Pi, Orange Pi, Banana Pi, Repka Pi, Pinebook и т.д.

SoC нуждается разве что во внешнем ОЗУ и некоторой периферии или разъёмов для подключения этой периферии, при этом SoC реализует в себе множество возможных, а иногда и взаимоисключающих конфигураций устройств. Таким образом, в системе должен быть механизм, позволяющийй передать ядру Linux информацию о том, какая из конфигураций соответствует тому, что распаяно на материнской плате. Данным механизмом является Devicetree.

> Важно понимать, что Devicetree — это не что-то очень крупное и сложное, а всего лишь *формат* описания конфигурации оборудования компьютера. Ядро читает эту конфигурацию для обнаружения нужного оборудования в компьютере и, таким образом, обеспечивает поддержку только тех устройств, которые описаны в файле Devicetree (при условии наличия драйверов для этих устройств).

## Файлы

### `*.dts`

Файл с расширением `*.dts` — представление дерева устройств в человекочитабельном текстовом формате, синтаксис которого похож на JSON. Компилируется программой `dtc` в бинарный файл `*.dtb`.

### `*.dtb`

`*.dtb` — уже двоичное (бинарное) представление информации из файла `*.dts`, которое читается ядром Linux.

### `*.dtbo` (overlay)

В дистрибутивах Raspbian и Armbian есть механизм, позволяющий во время загрузки применять к `*.dtb`-файлам патчи. Такой патч, содержащий какую-либо аппаратную возможность платы, называется overlay. Формат такого файла идентичен формату `*.dtb`. Обычно расположены в директории `/boot/dtb/<имя SoC>/overlay`.

## Откуда брать эти файлы

В новых версиях ядра существует целая библиотека с ванильными `*.dt{b,s}` файлами для многих известных компьютеров на архитектуре ARM. Для компиляции этих файлов (нужна программа `dtc`) , которые находятся в дереве исходного кода Linux, введите:

```bash
make CROSS_COMPILE=$LFA_TGT- ARCH=arm64 dtbs
```

В зависимости от параметров, указанных при конфигурировании ядра (в частности, в зависимости от того, поддержку каких SoC вы включили/отключили), будут скомпилированы нужные файлы `*.dtb`. После их компиляции вам нужно будет создать в директории `/boot` поддиректорию, в которую будут скопированы эти файлы.

Если в составе ядра нет `*.dts`-файла для вашего компьютера, то попробуйте взять его из дстрибутива (Armbian, Raspbian, etc.), где этот файл есть. Однако я не могу гарантировать в этом случае полную работоспособность системы с «чужим» файлом описания устройств.

---

> **Смотрите также:**
>
> - [**Linux and the Devicetree**](https://docs.kernel.org/devicetree/usage-model.html) (<https://docs.kernel.org/>);
> - [**Device Tree**](https://www.altlinux.org/Device_Tree) (<https://www.altlinux.org/>);
> - **<https://www.devicetree.org/>**.
