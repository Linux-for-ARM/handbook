# linux

{{#include pkgs/linux.md}}

Процесс сборки ядра состоит из нескольких процессов: конфигурирование, компиляция и установка. Прочитайте файл `README` в дереве исходного кода Linux, чтобы узнать об альтернативных методах, отличных от того, как конфигурируется ядро в этом руководстве.

## Подготовка

Убедитесь в том, что дерево исходного кода ядра не содержит лишних файлов:

```bash
make mrproper
```

Разработчики ядра рекомендуют выполнять эту команду каждый раз, когда вы собираете Linux.

## Настройка

> Поскольку вы создаёте встраиваемую систему, убедитесь, что все *ключевые* компоненты **встроены** в ядро, а не являются модулями (в меню, которое откроется по команде далеее опция отмечена как `<*>`, а не как `<M>`). Ключевыми обычно являются опции для поддержки консоли, видео, дисков и файловых систем, а также сети. Без них система не будет функционировать должным образом. Рекомендуется конфигурировать ядро без модулей, чтобы сэкономить место на диске и упростить процесс загрузки системы.

Откройте псевдографическое меню, в котором вам нужно выбрать все опции, которые нужны вам для корректной работы ядра на компьютере, для которого вы собираете систему:

```bash
make ARCH=arm64 CROSS_COMPILE=$LFA_TGT- menuconfig
```

## Сборка

```admonish warning title="Внимание"
В данном руководстве используется загрузчик U-Boot. Для него рекомендуется собрать ядро типа `uImage`. Добавьте `uImage` при компиляции ядра.
```

Скомпилируйте ядро, используя только что созданный `.config`:

```bash
make ARCH=arm64 CROSS_COMPILE=$LFA_TGT-
```

## Установка

> **Следующие действия нужно выполнить, если вы собирали ядро с модулями:**
>
> При использовании модулей ядра может потребоваться файл `/etc/modprobe.conf`. Информация, касающаяся модулей и конфигурации ядра, находится в документации в директории `Documentation/`. Также будет не лишним прочитать документацию (man) `modprobe.conf(5)`.
>
> ```bash
> make ARCH=arm64 CROSS_COMPILE=$LFA_TGT- \
>   INSTALL_MOD_PATH=$LFA_SYS modules_install
> ```

Конфигурационный файл `.config` содержит все настройки конфигурации только что собранного ядра. Было бы неплохим сохранить этот файл для дальнейшего пользования:

```bash
cp -v .config $LFA_SYS/boot/config-6.6.6
```

Скопируйте файл `System.map` в `/boot`:

```bash
cp -v System.map $LFA_SYS/boot/System.map-6.6.6
```

Полученное ядро будет находиться в директории `arch/arm64/boot`. Возможно, что там будет находиться несколько вариантов одного и того же ядра, просто с разным сжатием или добавлением помощников загрузчика. Следуйте инструкциям вашего загрузчика по копированию ядра в конечную систему. Например:

```bash
cp -iv arch/arm64/boot/Image $LFA_SYS/boot/vmlinuz-6.6.6
```

Для того, чтобы не указывать в опциях ядра полное имя `vmlinuz-6.6.6` создайте символическую ссылку:

```bash
ln -svf vmlinuz-6.6.6 $LFA_SYS/vmlinuz
```

Также в `arch/arm64/boot/dts` будут содержаться файлы Devicetree. Примерная структура директорий в `arch/arm64/boot`:

- `allwinner`
- `arm`
- `broadcom`
- `exynos`
- `hisilicon`
- `mediatek`
- `rockchip`
- ...

> В данном руководстве на данный момент поддерживаются платы на базе SoC Allwinner, Broadcom и Rockchip. Поддержка других моделей плат пока не планируется.

Создайте в `$LFA_SYS/boot` директорию `dtb-6.6.6`:

```bash
mkdir -pv $LFA_SYS/boot/dtb-6.6.6
```

После чего вам нужно в этой директории создать поддиректорию с именем SoC, который используется в вашей плате:

```bash
mkdir -pv $LFA_SYS/boot/dtb-6.6.6/<имя вашего SoC>
```

замените `<имя вашего SoC>` на имя SoC, которое используется в плате. Название указывайте с маленькой буквы.

Например, в точности, как названия директорий в `arch/arm64/boot`:

```bash
mkdir -pv $LFA_SYS/boot/dtb-6.6.6/allwinner
```

И скопируйте из `arch/arm64/boot/dts` соответствующую директорию с файлами Devicetree:

```bash
cp -rv arch/arm64/boot/dts/<имя вашего SoC>/*.dtb $LFA_SYS/boot/dtb-6.6.6/<имя вашего SoC>/
```

~~~admonish note title="Содержимое пакета" collapsible=true
- **Установленные файлы:** `.config-6.6.6`, `vmlinuz-6.6.6`, `System.map-6.6.6`, `dtb/*`

### Описание компонентов

- `.config` - содержит параметры сборки ядра.
- `Image`, `vmlinuz` - скомпилированное ядро Linux.
- `System.map` - список адресов и символов; в нём указаны точки входа и адреса всех функций и структур данных в ядре. Иногда полезен при отладке.
- `dtb/` - директория с файлами [devicetree](../additional/dtb.md).
~~~
